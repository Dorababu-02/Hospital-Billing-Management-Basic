<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Patients</title>
    <link rel="stylesheet" href="viewpat.css">
</head>
<body>
    <div class="main">
        <div class="head">
            <h1>Admitted Patients</h1>                                       
        </div>
        <div class="patient-table">
            <table>
                <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", async function () {
                const tableBody = document.querySelector("tbody"); 
                if (!tableBody) return;

                try {
                    const response = await fetch("/patients"); 
                    const result = await response.json();

                    if (result.success) {
                        console.log("Fetched patients:", result.data);
                        tableBody.innerHTML = ""; 

                        result.data.forEach(patient => {
                            const row = document.createElement("tr");
                            row.setAttribute("id", `patient-${patient.patientId}`);
                            row.innerHTML = `
                                <td>${patient.patientId}</td>
                                <td>${patient.patientName}</td>
                                <td>${patient.patientAge}</td>
                                <td>${patient.patientGender}</td>
                                <td>
                                    <button class="discharge-btn" 
                                        data-id="${patient.patientId}" 
                                        data-name="${patient.patientName}" 
                                        data-doctor="${patient.doctorName}" 
                                        data-mobile="${patient.mobileNumber}">
                                        Discharge
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        document.querySelectorAll(".discharge-btn").forEach(button => {
                            button.addEventListener("click", function () {
                                const patientId = this.getAttribute("data-id");
                                const patientName = this.getAttribute("data-name");
                                const doctorName = this.getAttribute("data-doctor");
                                const mobileNumber = this.getAttribute("data-mobile");

                                console.log("About to discharge:", { patientId, patientName, doctorName, mobileNumber });

                                const confirmDischarge = confirm("Are you sure you want to discharge this patient?");
                                if (confirmDischarge) {
                                    try {
                                        window.location.href = `billGen.html?id=${patientId}&name=${encodeURIComponent(patientName)}&doctor=${encodeURIComponent(doctorName)}&mobile=${encodeURIComponent(mobileNumber)}`;
                                    } catch (error) {
                                        console.error("Error redirecting to billing page:", error);
                                    }
                                }
                            });
                        });
                    } else {
                        console.error("Failed to fetch patient data:", result.message);
                    }
                } catch (error) {
                    console.error("Error fetching patients:", error);
                }
            });
        </script>    
    </div>
</body>
</html>
