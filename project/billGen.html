<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hospital Billing Form</title>
  <link rel="stylesheet" href="billGen.css" />
</head>
<body>
  <div class="container">
    <h2>Billing Form</h2>
    <form id="billing-form" action="/billing" method="post">
      <div id="status-message" style="text-align: center; margin-bottom: 10px; font-weight: bold;"></div>

      <label for="patientId">Patient ID</label>
      <input type="text" id="patientId" name="patientId" required readonly />

      <label for="patientName">Patient Name</label>
      <input type="text" id="patientName" name="patientName" required readonly />

      <label for="mobileNumber">Mobile Number</label>
      <input type="text" id="mobileNumber" name="mobileNumber" required readonly />

      <label for="date">Date</label>
      <input type="date" id="date" name="date" required readonly />

      <label for="doctorName">Doctor's Name</label>
      <input type="text" id="doctorName" name="doctorName" required readonly />

      <label for="labTests">Lab Tests (Total Cost)</label>
      <input type="number" id="labTests" name="labTests" min="0" required />

      <label for="medicines">Medicines (Total Cost)</label>
      <input type="number" id="medicines" name="medicines" min="0" required />

      <label for="consultationFees">Consultation Fees (Total Cost)</label>
      <input type="number" id="consultationFees" name="consultationFees" min="0" required />

      <label for="roomTaken">Room Taken?</label>
      <select id="roomTaken" name="roomTaken" required>
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>

      <div id="room-cost-section" style="display: none;">
        <label for="roomCost">Room Cost</label>
        <input type="number" id="roomCost" name="roomCost" min="0" />
      </div>

      <p id="total-bill-display"></p>
      <button type="button" class="btn" id="total-bill-btn">Total Bill</button>
      <button type="submit" class="btn">Generate Bill</button>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("date").value = new Date().toISOString().split('T')[0];

      const urlParams = new URLSearchParams(window.location.search);
      document.getElementById("patientId").value = urlParams.get("id") || "";
      document.getElementById("patientName").value = urlParams.get("name") || "";
      document.getElementById("doctorName").value = urlParams.get("doctor") || "";
      document.getElementById("mobileNumber").value = urlParams.get("mobile") || "";

    });
      document.getElementById("roomTaken").addEventListener("change", function () {
                const roomSection = document.getElementById("room-cost-section");
                if (this.value === "yes") {
                    roomSection.style.display = "block";
                } else {
                    roomSection.style.display = "none";
                    document.getElementById("roomCost").value = "";
                }
        });

    document.getElementById("total-bill-btn").addEventListener("click", function () {
      const labTests = parseFloat(document.getElementById("labTests").value) || 0;
      const medicines = parseFloat(document.getElementById("medicines").value) || 0;
      const consultationFees = parseFloat(document.getElementById("consultationFees").value) || 0;
      const roomCost = document.getElementById("roomTaken").value === "yes"
        ? (parseFloat(document.getElementById("roomCost").value) || 0)
        : 0;

      const totalBill = labTests + medicines + consultationFees + roomCost;
      document.getElementById("total-bill-display").innerText = "Total Bill: â‚¹" + totalBill.toFixed(2);
    });

    document.getElementById("billing-form").addEventListener("submit", async function (event) {
                event.preventDefault(); // prevent default form submission
        
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
        
                // If room not taken, remove roomCost or set it to 0
                if (data.roomTaken === "no") {
                    data.roomCost = 0;
                }
        
                try {
                    const response = await fetch("/billing", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
        
                    const result = await response.json();
        
                    const statusMessage = document.getElementById("status-message");

                    if (result.success) {
                        statusMessage.textContent = "Patient discharged successfully.";
                        statusMessage.style.color = "green";

                        this.reset(); // clear form
                        document.getElementById("total-bill-display").innerText = "";
                        document.getElementById("room-cost-section").style.display = "none";
                        document.getElementById("date").value = new Date().toISOString().split('T')[0];
                        window.location.href = result.redirect;
                    } else {
                        statusMessage.textContent = "Failed to store billing data. Please try again.";
                        statusMessage.style.color = "red";
                    }

                } catch (error) {
                    console.error("Error submitting form:", error);
                    alert("Server error. Please try again later.");
                }
            });
  </script>
</body>
</html>
